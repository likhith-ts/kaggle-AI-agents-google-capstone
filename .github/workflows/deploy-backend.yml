# =============================================================================
# GitHub Actions: Deploy Backend to Cloud Run
# =============================================================================
# Triggers on push to master when backend/ files change
#
# NOTE: This workflow uses inline commands instead of external actions
# because some organizations restrict action usage to their own repos.
#
# Prerequisites:
# 1. Create a Service Account in GCP with roles:
#    - Cloud Run Admin
#    - Cloud Build Editor
#    - Service Account User
#    - Storage Admin
# 2. Create and download a JSON key for the service account
# 3. Add GitHub Secrets:
#    - GCP_SA_KEY: The entire JSON key file contents
#    - NEON_DATABASE_URL: Your Neon PostgreSQL connection string
#    - UPSTASH_REDIS_REST_URL: Your Upstash Redis REST URL
#    - UPSTASH_REDIS_REST_TOKEN: Your Upstash Redis token
# =============================================================================

name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - master
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch: # Allow manual trigger

env:
  PROJECT_ID: kaggle-ai-agents-competition
  REGION: us-central1
  SERVICE_NAME: incident-triage-agent
  VERTEX_AI_LOCATION: global
  VERTEX_AI_MODEL: gemini-3-pro-preview
  VERTEX_EMBEDDING_MODEL: text-embedding-004

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        run: |
          git clone --depth 1 https://github.com/${{ github.repository }}.git .
          git checkout ${{ github.sha }}

      - name: Setup Google Cloud SDK
        run: |
          # Install gcloud CLI
          curl -sSL https://sdk.cloud.google.com | bash -s -- --disable-prompts --install-dir=$HOME
          echo "$HOME/google-cloud-sdk/bin" >> $GITHUB_PATH

      - name: Authenticate to Google Cloud
        run: |
          # Write service account key to file
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json

          # Authenticate with gcloud
          $HOME/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
          $HOME/google-cloud-sdk/bin/gcloud config set project ${{ env.PROJECT_ID }}

          # Configure Docker for GCR
          $HOME/google-cloud-sdk/bin/gcloud auth configure-docker --quiet

          # Cleanup key file
          rm /tmp/gcp-key.json

      - name: Deploy to Cloud Run (from source)
        working-directory: backend
        run: |
          $HOME/google-cloud-sdk/bin/gcloud run deploy ${{ env.SERVICE_NAME }} \
            --source . \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300s \
            --min-instances 0 \
            --max-instances 10 \
            --set-env-vars "\
          APP_ENV=production,\
          APP_NAME=${{ env.SERVICE_NAME }},\
          DEBUG=false,\
          USE_STUB_LLM=false,\
          LOG_LEVEL=INFO,\
          JSON_LOGS=true,\
          FRONTEND_URL=http://localhost:3000,\
          GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }},\
          GOOGLE_CLOUD_LOCATION=${{ env.REGION }},\
          VERTEX_AI_LOCATION=${{ env.VERTEX_AI_LOCATION }},\
          VERTEX_AI_MODEL=${{ env.VERTEX_AI_MODEL }},\
          VERTEX_EMBEDDING_MODEL=${{ env.VERTEX_EMBEDDING_MODEL }},\
          NEON_DATABASE_URL=${{ secrets.NEON_DATABASE_URL }},\
          PGVECTOR_COLLECTION=runbooks,\
          UPSTASH_REDIS_REST_URL=${{ secrets.UPSTASH_REDIS_REST_URL }},\
          UPSTASH_REDIS_REST_TOKEN=${{ secrets.UPSTASH_REDIS_REST_TOKEN }},\
          SECRET_KEY=${{ secrets.SECRET_KEY }}"

      - name: Get Service URL
        run: |
          SERVICE_URL=$($HOME/google-cloud-sdk/bin/gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "ðŸš€ Deployed to: $SERVICE_URL"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV

      - name: Smoke Test
        run: |
          echo "Testing health endpoint..."
          curl -sf "$SERVICE_URL/health" | jq .
          echo "âœ… Health check passed!"
